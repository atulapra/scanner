name: Daily Options Scan

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set today's date
        id: date
        run: echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Set TODAY env
        run: echo "TODAY=${{ steps.date.outputs.today }}" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unusual options scanner
        run: |
          python scanner/unusual_options_scan.py

      - name: Upload scan results artifact
        uses: actions/upload-artifact@v4
        with:
          name: options-scan-results-${{ env.TODAY }}
          path: |
            unusual_options_scan_${{ env.TODAY }}*.csv
            unusual_options_scan_${{ env.TODAY }}*_summary.csv

      - name: Send email with today's scan results
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Daily Options Scan Results - ${{ env.TODAY }}"
          to: atulbalaji318@gmail.com, atulapra@gmail.com
          from: "Options Scanner <${{ secrets.SMTP_USERNAME }}>"
          secure: false
          attachments: |
            unusual_options_scan_${{ env.TODAY }}*_summary.csv
            unusual_options_scan_${{ env.TODAY }}*.csv
          html_body: |
            <p>Your daily options scan for <b>${{ env.TODAY }}</b> is complete.</p>
            <p>Attached files:</p>
            <ul>
              <li><b>Summary CSV</b> (per-ticker call/put ranges, flows, OI trends)</li>
              <li><b>Detailed CSV</b> (contract-level data with volume, vol/OI, trends)</li>
            </ul>
            <p>These include only today's results.</p>
